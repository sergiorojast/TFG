<div class="row m-2">
    <div class="col">
        <div class="card carta">
            <h1 class="text-center">Resumen Usuarios</h1>
            <div class="row m-2">

                <div class="col mb-5 ">
                    <div class="card carta" id="tabla">

                        <div class="table-responsive">

                            <table class="table table-striped table-hover ">
                                <thead class="text-center thead-dark">
                                    <tr>

                                        <th scope="col"> imagen</th>
                                        <th scope="col">Correo</th>
                                        <th scope="col">Nombre</th>
                                        <th scope="col"> rol</th>
                                        <th scope="col"></th>
                                    </tr>
                                </thead>
                                <tbody id="cuerpoTabla" class="text-center">

                                </tbody>
                            </table>
                            <div class='btn-group btn-group-sm m-5 float-right' id="botonesPaginacion" role='group'>
                                <button type='button' class='btn btn-primary' id='botonAlPrincipio'><span
                                        class='fa fa-chevron-left'></span><span
                                        class='fa fa-chevron-left'></span></button>
                                        <span id='paginasIniciales' class="btn btn-primary"></span>


                                <button type='button' class='btn btn-primary' id='botonAnterior'><span
                                        class='fa fa-chevron-left'></span>
                                </button>
                                <span id='paginasActuales' class="btn btn-primary"></span>

                                <button type='button' class='btn btn-primary' id="botonSiguiente"><span
                                        class='fa fa-chevron-right'></span>
                                </button>
                                <span id='paginasFinales' class="btn btn-primary"></span>
                                <button type='button' class='btn btn-primary' id="botonAlFinal"><span
                                        class='fa fa-chevron-right'></span><span
                                        class='fa fa-chevron-right'></span></button>

                                </button>

                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <div class="row m-2">
                <div class="col-4">
                    <div class="card carta p-2">
                        <p> Número total usuarios: <span id="usuariosTotales"></span></p>
                        <p>Número usuarios Administradores: <span id="usuariosAdministradores"></span></p>
                        <p>Número usuarios avanzados: <span id="usuariosAvanzados"></span></p>
                        <p>Número usuarios normlaes :<span id="usuariosNormales"></span></p>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>


<script>
    solicitarYPintarDatos();


    // cargamos los datos de los usuarios
    function solicitarYPintarDatos() {
        $.ajax({
                type: "POST",
                url: webService,
                data: {
                    'accion': 'usuarios'
                }
            })
            .done(function (data) {
                pintarTabla(data)

            }).fail(function () {
                bootbox.alert("Fallo en AJAX¡", function () {
                    setTimeout(function () {
                        window.location = LOGIN;
                    }, 2000)
                });
            })


        function pintarTabla(data) {

            let usuarioAdministrador = 0;
            let usuarioAvanzado = 0;
            let usuarioNormal = 0;
            let rolEnTexto = "";
            let usuarios = JSON.parse(data);
            if (usuarios.length > 0) {
                $('#botonesPaginacion').removeClass('d-none')
                $(usuarios).each(function (i, e) {
                    let columna = "";
                    let celda = ""
                    columna = document.createElement('tr');

                    celda = document.createElement("td");
                    $(celda).html("<img src='" + repositorioImagenes + "/" + e.imagen +
                        "' class='img-fluid imagenCrud'>");
                    columna.appendChild(celda);

                    celda = document.createElement("td");
                    $(celda).html(e.correo);
                    columna.appendChild(celda);
                    celda = document.createElement("td");
                    $(celda).html(e.nombre + ", " + e.apellidos);
                    columna.appendChild(celda);

                    if (e.rol >= 90) {
                        usuarioAdministrador++;
                        rolEnTexto = "<span class='text-danger'>Administrador</span>";
                    } else if (e.rol >= 50 && e.rol < 90) {
                        usuarioAvanzado++;
                        rolEnTexto = "<span class='text-warning'>Avanzado</span>";

                    } else {
                        usuarioNormal++;
                        rolEnTexto = "<span class='text-primary'>Normal</span>";

                    }
                    celda = document.createElement("td");
                    $(celda).html(rolEnTexto);
                    columna.appendChild(celda);


                    celda = document.createElement("td");
                    $(celda).html("" +
                        "<div class='btn-group btn-group-sm' role='group'>" +
                        "<button type='button' class='btn btn-primary'  data-toggle='tooltip' data-placement='top'title='Visualizar'><span class='fa fa-eye'></span></button>" +
                        "<button type='button' class='btn btn-warning '   data-toggle='tooltip' data-placement='top'title='Modificar'><span class='fa fa-pencil-alt'></span></button>" +
                        "<button type='button' class='btn btn-danger' data-toggle='tooltip' data-placement='top'title='Eliminar'><span class='fa fa-trash'  ></span></button>" +

                        "<div class='btn-group btn-group-sm' role='group'>" +
                        "<button id='btnGroupDrop1' type='button' class='btn btn-secondary dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>" +
                        "" +
                        "</button>" +
                        "<div class='dropdown-menu' >" +
                        "<a class='dropdown-item' href='#'>Ver proyectos asignados</a>" +
                        "<a class='dropdown-item' href='#'>Ver tareas Asignadas</a>" +
                        "<a class='dropdown-item' href='#'>Ver anotaciones del usuario</a>" +
                        "</div>" +
                        "</div>" +
                        "</div>");

                    columna.appendChild(celda);

                    $(columna).addClass('d-none');
                    $(columna).attr('id', i + 1);

                    $('#cuerpoTabla').append(columna);

                })


                $('#usuariosTotales').html(usuarios.length);

                $('#usuariosAdministradores').html(usuarioAdministrador);
                $('#usuariosAvanzados').html(usuarioAvanzado);
                $('#usuariosNormales').html(usuarioNormal);



                $('button[data-toggle="tooltip"]').tooltip();
                paginacion();
            } else {
                $('#botonesPaginacion').addClass('d-none')
            }
        };


        function paginacion() {
            let numeroElementosPorPagina = 5;
            let cantidadElmentosTotales = $('tbody tr').length;
            let idUltimoElementovisible = 1;
            // idUltimoElementovisible=  $('tbody tr:not(d-none)').attr('id');


            //muestra los primeros datos 
            for (let i = idUltimoElementovisible; i < idUltimoElementovisible + numeroElementosPorPagina; i++) {
                if (i <= cantidadElmentosTotales) {
                    $('#' + i).removeClass('d-none');
                }

            }
            comprobarBotonesActivos();

            $('#botonSiguiente').click(botonSiguiente);
            //$('#botonAnterior').click(botonAnterior)
            //$('#botonAlPrincipio').click(botonAlPrincipio);
            $('#botonAlFinal').click(botonAlFinal);



            function comprobarBotonesActivos() {


                idUltimoElementovisible = parseInt($('tbody tr:not(.d-none):last').attr('id'));


                if (idUltimoElementovisible == 1 || idUltimoElementovisible <= numeroElementosPorPagina) {
                    $('#botonAnterior').addClass('disabled');
                    $('#botonAlPrincipio').addClass('disabled');
                    $('#paginasIniciales').addClass('disabled');

                    $('#botonAnterior').off('click');
                    $('#botonAlPrincipio').off('click');
                } else {
                    $('#botonAnterior').removeClass('disabled');
                    $('#botonAlPrincipio').removeClass('disabled');
                    $('#paginasIniciales').remove('disabled');

                    if ($('#botonAnterior').attr('class') !== 'btn btn-primary disabled') {

                        $('#botonAnterior').off('click');
                        $('#botonAlPrincipio').off('click');
                        $('#botonAnterior').click(botonAnterior);
                        $('#botonAlPrincipio').click(botonAlPrincipio);
                    }


                }
                if (idUltimoElementovisible >= cantidadElmentosTotales) {
                    $('#botonSiguiente').addClass('disabled');
                    $('#botonAlFinal').addClass('disabled');
                    $('#paginasFinales').addClass('disabled');
                    $('#botonSiguiente').off('click');
                    $('#botonAlFinal').off('click');
                } else {
                    if ($('#botonSiguiente').attr('class') !== 'btn btn-primary') {

                        $('#botonSiguiente').removeClass('disabled');
                        $('#paginasFinales').removeClass('disabled');
                        $('#botonAlFinal').removeClass('disabled');
                        $('#botonSiguiente').off('click');
                        $('#botonAlFinal').off('click');
                        $('#botonSiguiente').click(botonSiguiente);
                        $('#botonAlFinal').click(botonAlFinal);
                    }

                }
                cambiarNumeracion();
            }

            function botonSiguiente() {

                idUltimoElementovisible = parseInt($('tbody tr:not(.d-none):last').attr('id'));
                for (let i = idUltimoElementovisible; i > idUltimoElementovisible -
                    numeroElementosPorPagina; i--) {
                    $('#' + i).removeClass('d-none');
                    $('#' + i).addClass('d-none');

                }
                for (let i = idUltimoElementovisible + 1; i < idUltimoElementovisible +
                    numeroElementosPorPagina + 1; i++) {

                    $('#' + i).removeClass('d-none');


                }
                comprobarBotonesActivos();
            }

            function botonAnterior() {
                idUltimoElementovisible = parseInt($('tbody tr:not(.d-none):first').attr('id'));
                console.log(idUltimoElementovisible)
                $('#cuerpoTabla tr').addClass('d-none');



                if (idUltimoElementovisible % numeroElementosPorPagina != 0) {
                    idUltimoElementovisible = parseInt(idUltimoElementovisible - idUltimoElementovisible %
                        numeroElementosPorPagina);
                }
                console.log(idUltimoElementovisible);


                for (let i = idUltimoElementovisible; i > idUltimoElementovisible -
                    numeroElementosPorPagina; i--) {
                    console.log("Usuarios mostrados-->" + i);
                    $('#' + i).removeClass('d-none');


                    if (i <= 1) {
                        for (let u = i; u <= numeroElementosPorPagina; u++) {
                            $('#' + u).removeClass('d-none');


                        }
                    }
                }

                comprobarBotonesActivos();


            }

            function botonAlPrincipio() {


                $('tbody tr').addClass('d-none');

                for (let i = 1; i <= numeroElementosPorPagina; i++) {
                    $('#' + i).removeClass('d-none');


                }
                comprobarBotonesActivos();
            }

            function botonAlFinal() {

                cantidadElementosMostrar = parseInt(cantidadElmentosTotales % numeroElementosPorPagina);
                if (cantidadElementosMostrar == 0) {
                    cantidadElementosMostrar = numeroElementosPorPagina;
                }

                $('tbody tr').addClass('d-none');

                for (let i = cantidadElmentosTotales; i >
                    cantidadElmentosTotales - cantidadElementosMostrar; i--) {
                    $('#' + i).removeClass('d-none');

                }
                comprobarBotonesActivos();
            }

            function cambiarNumeracion() {
                $('#paginasActuales').html(parseInt($('tbody tr:not(.d-none):first').attr('id')) + "···" + parseInt($(
                    'tbody tr:not(.d-none):last').attr('id')))
                $('#paginasFinales').html(cantidadElmentosTotales - numeroElementosPorPagina + "···" +
                    cantidadElmentosTotales)
                    $('#paginasIniciales').html(1+ "···" +numeroElementosPorPagina)
            }

        }
    }
</script>